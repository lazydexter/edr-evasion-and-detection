# Anti-Sandboxing Techniques in Malware

## 📌 What is Anti-Sandboxing?
Anti-sandboxing refers to techniques used by adversaries to **detect or evade execution inside a sandbox environment**.  
Sandboxes are isolated VMs used by researchers and automated security tools to safely execute suspicious files and monitor behavior.  

The goal of anti-sandboxing is simple:  
➡️ If malware detects it is inside a sandbox, it will **delay, exit, or alter behavior** to avoid detection.

---

## 🎯 Purpose
- **Malware developers / Red teamers:** Prevent payloads from being analyzed and flagged in automated sandboxes.  
- **Defenders / Blue teamers:** Understand these techniques to **improve sandbox realism** and design detections.  

---

## 🚩 Common Anti-Sandboxing Techniques
- **User interaction checks** → No mouse movement or keystrokes.  
- **Resource checks** → Low RAM (<4 GB), single CPU core, small disk.  
- **Screen resolution** → Very low resolutions (800×600).  
- **Artifact detection** → Look for known sandbox DLLs (e.g., `VBoxGuest.dll`, `SbieDll.dll`) or processes (`VBoxService.exe`, `vmtoolsd.exe`).  
- **Registry & BIOS checks** → Keys or strings referencing VMware, VirtualBox, QEMU.  
- **Timing attacks** → Detect abnormal delays in `Sleep()` or timers.  
- **MAC address check** → Virtual adapters have known prefixes (`08:00:27` for VirtualBox, `00:0C:29` for VMware).  

---

## 🕵️ Red Team Perspective — How Adversaries Bypass
- **Early exit or delay**: Exit program if sandbox indicators are found, or use long sleeps to outlast sandbox run time.  
- **Environment fingerprinting**: Check resolution, CPU, DLLs, registry.  
- **Payload hiding**: Only deploy second stage if a “real” user environment is detected.  
- **User activity simulation**: Wait for keystrokes, clipboard usage, or mouse movement before executing.  

---

## 🛡️ Blue Team Perspective — How to Detect
- **Process monitoring**: Watch for unusual use of APIs such as `GetSystemMetrics`, `GetCursorPos`, `GetLastInputInfo`.  
- **Sysmon Event ID 7 (Image loaded)**: Detect processes loading `VBoxGuest.dll`, `SbieDll.dll`, etc.  
- **Behavioral detection**: Look for long `Sleep()` calls before network activity or injection.  
- **Threat hunting queries**:  
  - Correlate low-resource VMs + suspicious process trees.  
  - Detect lack of user interaction paired with malware-like actions.  
- **Sandbox hardening**: Add mouse movement, realistic RAM/CPU, proper screen resolution, and background processes to reduce detectability.  

---

## ✅ Summary
- Anti-sandboxing = adversary tactic to avoid analysis.  
- Red teamers use it to simulate realistic malware behavior.  
- Blue teamers must detect API calls, DLL artifacts, and suspicious timing tricks.  
- Defenders can harden sandboxes and hunt for these behaviors in telemetry.  

---

## 📌 Disclaimer
This content is for **defensive research and education** only.  
No malicious code or payloads are included.  
